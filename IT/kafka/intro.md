Зачем кафка?

- отправка сообщений сразу многим получателям
- нет потери сообщений если получатель недоступен
- добавления получателя не требует доработки отправителя

В случае, если используется REST, сообщения отправляются напрямую.

С кафкой сообщения сначала публикуются в кафка топик и уже из топика другие 
сервисы считывают сообщения.

Тот кто публикует сообщения называется Producer или Publisher, а те кто 
читают сообщения называется Consumer или Subscriber.

Producer не знает о Consumer, а Consumer про Producer.

Это позволяется добавлять Consumer при этом не делать изменения в Producer.

Это называется Event Driver Architecture - события публикуются, что 
явлляется триггером для дальнейших действий.

 - Асинхронное взаимодействие
 - Слабые связи
 - Гибкость изменений
 - Легкое масштабирование
 - Consumer пожет обработать сообзения после восстановления
 - Producer не ждет отбработки, не знает про то, кто обрабатывает

Kafka Broker - сервер, который получает сообщение от producer и сохраняте 
сообщение на диске, после чего передает его в consumer. 

Каждый broker отвечает за управление одним или несколькими topic, которые 
разделены на partition для распределения даннных. Каждый новый event 
сохраняется в partition.
Broker выполняют важную роль в обеспечении отказоустойчивости и 
масштабируемости в Kafka.
```

                               Kafka Cluster
+—————————————————————————————————————————————————————————————————————————+
|                                                                         |
|                                Broker                                   |
|   +—————————————————————————————————————————————————————————————————+   |
|   |                                                                 |   |
|   |             Topic                            Topic              |   |
|   |   +—————————————————————————+     +—————————————————————————+   |   |
|   |   |                         |     |                         |   |   |
|   |   |        Partition        |     |       Partition         |   |   |
|   |   |    +——————————————+     |     |    +——————————————+     |   |   |
|   |   |    |    |    |    |     |     |    |    |    |    |     |   |   |
|   |   |    |————|————|————|     |     |    |————|————|————|     |   |   |
|   |   |    |    |    |    |     |     |    |    |    |    |     |   |   |
|   |   |    |————|————|————|     |     |    |————|————|————|     |   |   |
|   |   |    |    |    |    |     |     |    |    |    |    |     |   |   |
|   |   |    +——————————————+     |     |    +——————————————+     |   |   |
|   |   |                         |     |                         |   |   |
|   |   +—————————————————————————+     +—————————————————————————+   |   |
|   |                                                                 |   |
|   +—————————————————————————————————————————————————————————————————+   |
|                                                                         |
+—————————————————————————————————————————————————————————————————————————+

```



Kafka cluster - несколько broker синхронизированных между собой.

Kafka event - название состоит из названия сущности над которой происходит 
действие + название действия + постфикс event.

Topic - к нему подключаются consumer и читают сообщения. Состоит из 
partition, event из partition читаются по порядку.

Offset - partition index.

Event добавляется в конец partition
Event нельзя изменить или удалить.

По умолчания topic настроен на хранение events в течении 7 дней, но можно 
изменить.
Даже после прочтения event он продолжает хранится еще 7 дней.

Изначально event распределяются между partitions, а consumer читает 
event паралельно, то есть не гарантируется очередность чтения из partition.

Если отправлять event с одинаковым key то они будут попадать в одну partition.

Message состоит из
- Key(message id)
- Event (message value)
- Timestamp (creation time)
- Headers (optional, ex: auth header)

--------------------------------------------------------------------------------
# Kafka

Сложность передачи данных:
- надежность и гарантия доставки
- подключение новых получателей
- отпраители знают получателей
- техническая поддержка
- интеграции разных стеков


Решение: использовать посредника, брокера сообщений, который примет функцию 
получения и предоставления данных.

Удобства:
- надежность и гарантия доставки
- подключение новых получателей
- отправители не знают получателей
- тезническая поддержка
- интеграции разных стеков

### Основные сущности Кафки
- broker
- cluster
- zookeeper
- message (record)
- topic/partition
- producer
- consumer


### Broker (Kafka Server / Kafka Node)

Функции:
- прием сообщений
- хранение сообщений
- выдача сообщений

Создаются несколько брокеров для надежности и производительности.
Брокеры могут общаться между собой образуя кластер. Это нужно для надежности 
хранения данных.

### Zookeeper

Хранилище, небольшая база данных, которая быстро работает на чтение и не 
очень быстро на запись. 
Используется для:
- хранения метаданых
- состояний кластера
- конфигурация
- информация о брокерах
- партиции итд.

### Message (Record / Event)

Состоит из:
- key ( ключ, который используется для распределения сообщений по сластеру )
- value ( содержимое сообщения - массив байт )
- timestamp ( время сообщения. устанавливается при отправке/обработке внутри кластера )
- headers  ( набор key-value с пользовательскими отрибутами сообщения )

### Topic / Partitions

Основная сущность кафки, стрим данных. Сообщения можно складывать в топик в 
очередь откуда сообщения извлекаются. 

Сообщения при чтении не удаляются из топика, это позволяет чтение сообщений 
несколькими получаетлями.

Плохо работает при больших нагрузках.

В итоге, одна очередь в топике была разделена на партиции. ( конфигурируемый параметер )
Нужны для распараллеливание нагрузки.
Ускоряют чтение/запись данных.

Сообщения отправляются в топик, сообщения распределяются по партициям, 
потребитиль читает сообщения, не в порядке в котором они были отправлены 
продюсером, а в порядке в котором лежат в партиции.

Чтоб сохранить очередность чтения сообщений, сообщения нужно отправлять с 
одинаковым ключем, тогда они будут помещены в одну партицию.

Топик размещен в нескольких брокерах, партиции распределяются по брокерам.

Данные хранятся в log файлах.

Есть папка logs, в ней есть папки с названием имя топик + номер партиции
